<div class="ai-assistant-container">
  <header class="ai-assistant-header">
    <div class="header-title">
      <div class="title-row">
        <h2>AI Assistant</h2>
      </div>
    </div>
    <div class="header-actions">
      <button class="expand-button" (click)="toggleExpanded()">
        <span class="material-symbols-outlined">
          @if (isExpanded()) {
            close_fullscreen
          } @else {
            open_in_full
          }
        </span>
      </button>
      <button class="close-button" (click)="close.emit()">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
  </header>
  <div class="ai-assistant-body">
    <div class="messages-container" #messagesContainer>
      @if (aiConfigState.isLoading()) {
        <message-spinner message="Checking available models for chat..." />
      } @else if (aiConfigState.error() !== undefined) {
        Error fetching available models.
      } @else if (models().length === 0) {
        @if (models().length === 0) {
          No models available. Make sure you set API keys as per
          <a
            href="https://github.com/angular/web-codegen-scorer?tab=readme-ov-file#setup"
            target="_blank"
            >Setup instructions.</a
          >
        }
      } @else {
        @for (message of messages; track $index) {
          <div
            class="message"
            [class.user-message]="message.role === 'user'"
            [class.model-message]="message.role === 'model'"
          >
            <div [innerHTML]="message.text"></div>
          </div>
        }
        @if (isLoading()) {
          <div class="message model-message">
            <message-spinner message="Thinking..." />
          </div>
        }
      }
    </div>
    <div class="ai-assistant-footer">
      <button (click)="toggleContextExpanded()" class="context-expansion-button">
        <span>Chat options</span>
        <span class="material-symbols-outlined">
          @if (isContextExpanded()) {
            expand_less
          } @else {
            expand_more
          }
        </span>
      </button>

      @if (isContextExpanded()) {
        <div class="context-options-container">
          <div class="context-selector-container">
            <label>Apps</label>
            <select [(ngModel)]="selectedReportContext">
              <option [value]="ReportContextFilter.ActiveReports">Open apps</option>
              <option [value]="ReportContextFilter.AllReports">All apps</option>
              <option [value]="ReportContextFilter.NonPerfectReports">Non-perfect apps</option>
            </select>
          </div>
          <div class="context-selector-container">
            <label>Checks</label>
            <select [(ngModel)]="selectedRatingContext">
              <option [value]="RatingContextFilter.AllRatings">All checks</option>
              <option [value]="RatingContextFilter.NonPerfectRatings">Non-perfect checks</option>
            </select>
          </div>
          <div class="model-selector-container">
            <label>Model</label>
            <select [(ngModel)]="selectedModel">
              @for (model of models(); track model) {
                <option [value]="model">{{ model }}</option>
              }
            </select>
          </div>
        </div>
      }
    </div>
    <div class="input-container">
      <textarea
        #userInputElement
        [(ngModel)]="userInput"
        placeholder="Ask a question about the report..."
        (keydown.enter)="$event.preventDefault(); send()"
        [readonly]="isLoading()"
      ></textarea>
      <button (click)="send()" [disabled]="isLoading()">
        <span class="material-symbols-outlined">send</span>
      </button>
    </div>
  </div>
</div>
